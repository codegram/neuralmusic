---

title: Parsing and representing MIDI notes
keywords: fastai
sidebar: home_sidebar

summary: "Finding a compact representation of melody and rhythm."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_midi.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="67f4c685-5c13-4355-b1a8-e1e2da631828"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#67f4c685-5c13-4355-b1a8-e1e2da631828');

            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "# export\nfrom typing import Optional, Tuple, Collection\nimport re\n\nfrom music21 import (\n    converter,\n    instrument,\n    note,\n    chord,\n    pitch,\n    interval,\n    stream,\n    volume,\n    duration,\n    midi,\n    meter,\n    key,\n    tempo,\n)\nfrom music21.midi import MidiException\nimport pandas as pd";
                var nbb_formatted_code = "# export\nfrom typing import Optional, Tuple, Collection\nimport re\n\nfrom music21 import (\n    converter,\n    instrument,\n    note,\n    chord,\n    pitch,\n    interval,\n    stream,\n    volume,\n    duration,\n    midi,\n    meter,\n    key,\n    tempo,\n)\nfrom music21.midi import MidiException\nimport pandas as pd";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="df64bb6b-07f0-417c-bc9e-be2e064e5098"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#df64bb6b-07f0-417c-bc9e-be2e064e5098');

            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "# export\n\nPitch, Duration, Velocity = str, float, int\nTriplet = Tuple[Pitch, Duration, Velocity]";
                var nbb_formatted_code = "# export\n\nPitch, Duration, Velocity = str, float, int\nTriplet = Tuple[Pitch, Duration, Velocity]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we'll create some functions to turn single notes, chords and rests into these Triplets.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e97dbe1f-7d9c-4849-bd33-175df4cefbed"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e97dbe1f-7d9c-4849-bd33-175df4cefbed');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "# export\n\n\ndef _parse_duration(d: duration.Duration) -> Optional[str]:\n    try:\n        dur = float(d.quarterLength)\n        name = d.type\n        if dur > 0.0 and dur <= 32.0 and name != \"inexpressible\":\n            return name\n        else:\n            return None\n    except duration.DurationException:\n        return None\n\n\ndef _parse_single_note(note: note.Note) -> Optional[Triplet]:\n    dur = _parse_duration(note.duration)\n    if dur is not None:\n        return (str(note.pitch), dur, note.volume.velocity)\n    else:\n        return None\n\n\ndef _parse_chord(chord: chord.Chord) -> Optional[Triplet]:\n    dur = _parse_duration(chord.duration)\n    if dur is not None:\n        return (\".\".join(str(n) for n in chord.normalOrder), dur, chord.volume.velocity)\n    else:\n        return None\n\n\ndef _parse_rest(rest: note.Rest) -> Optional[Triplet]:\n    dur = _parse_duration(rest.duration)\n    if dur is not None:\n        return (\"R\", dur, 0)\n    else:\n        return None";
                var nbb_formatted_code = "# export\n\n\ndef _parse_duration(d: duration.Duration) -> Optional[str]:\n    try:\n        dur = float(d.quarterLength)\n        name = d.type\n        if dur > 0.0 and dur <= 32.0 and name != \"inexpressible\":\n            return name\n        else:\n            return None\n    except duration.DurationException:\n        return None\n\n\ndef _parse_single_note(note: note.Note) -> Optional[Triplet]:\n    dur = _parse_duration(note.duration)\n    if dur is not None:\n        return (str(note.pitch), dur, note.volume.velocity)\n    else:\n        return None\n\n\ndef _parse_chord(chord: chord.Chord) -> Optional[Triplet]:\n    dur = _parse_duration(chord.duration)\n    if dur is not None:\n        return (\".\".join(str(n) for n in chord.normalOrder), dur, chord.volume.velocity)\n    else:\n        return None\n\n\ndef _parse_rest(rest: note.Rest) -> Optional[Triplet]:\n    dur = _parse_duration(rest.duration)\n    if dur is not None:\n        return (\"R\", dur, 0)\n    else:\n        return None";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test</span>
<span class="kn">from</span> <span class="nn">testing</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">quarter</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="s2">&quot;quarter&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">loud</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">Note</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">note</span><span class="o">.</span><span class="n">Note</span><span class="p">:</span>
    <span class="n">n</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">velocity</span><span class="o">=</span><span class="n">velocity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span>


<span class="n">test_eq</span><span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;quarter&quot;</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">_parse_single_note</span><span class="p">(</span><span class="n">loud</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">quarter</span><span class="p">)))</span>
<span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_parse_single_note</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">34.0</span><span class="p">))))</span>

<span class="n">test_eq</span><span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;1.3.5&quot;</span><span class="p">,</span> <span class="s2">&quot;quarter&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
    <span class="n">_parse_chord</span><span class="p">(</span><span class="n">loud</span><span class="p">(</span><span class="n">chord</span><span class="o">.</span><span class="n">Chord</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">duration</span><span class="o">=</span><span class="n">quarter</span><span class="p">),</span> <span class="n">velocity</span><span class="o">=</span><span class="mi">80</span><span class="p">)),</span>
<span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_parse_chord</span><span class="p">(</span><span class="n">chord</span><span class="o">.</span><span class="n">Chord</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))))</span>

<span class="n">test_eq</span><span class="p">((</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;quarter&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">_parse_rest</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">Rest</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">quarter</span><span class="p">)))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_parse_rest</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">Rest</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="2c28c409-469d-41b5-98c1-986a5f96e6c4"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#2c28c409-469d-41b5-98c1-986a5f96e6c4');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "# test\nfrom testing import test_eq\n\nquarter = duration.Duration(\"quarter\")\n\n\ndef loud(n: note.Note, velocity=120) -> note.Note:\n    n.volume = volume.Volume(velocity=velocity)\n    return n\n\n\ntest_eq(\n    (\"C3\", \"quarter\", 120), _parse_single_note(loud(note.Note(\"C3\", duration=quarter)))\n)\ntest_eq(None, _parse_single_note(note.Note(\"C3\", duration=duration.Duration(34.0))))\n\ntest_eq(\n    (\"1.3.5\", \"quarter\", 80),\n    _parse_chord(loud(chord.Chord([1, 3, 5], duration=quarter), velocity=80)),\n)\ntest_eq(None, _parse_chord(chord.Chord([1, 3, 5], duration=duration.Duration(0.0))))\n\ntest_eq((\"R\", \"quarter\", 0), _parse_rest(note.Rest(duration=quarter)))\ntest_eq(None, _parse_rest(note.Rest(duration=duration.Duration(0.0))))";
                var nbb_formatted_code = "# test\nfrom testing import test_eq\n\nquarter = duration.Duration(\"quarter\")\n\n\ndef loud(n: note.Note, velocity=120) -> note.Note:\n    n.volume = volume.Volume(velocity=velocity)\n    return n\n\n\ntest_eq(\n    (\"C3\", \"quarter\", 120), _parse_single_note(loud(note.Note(\"C3\", duration=quarter)))\n)\ntest_eq(None, _parse_single_note(note.Note(\"C3\", duration=duration.Duration(34.0))))\n\ntest_eq(\n    (\"1.3.5\", \"quarter\", 80),\n    _parse_chord(loud(chord.Chord([1, 3, 5], duration=quarter), velocity=80)),\n)\ntest_eq(None, _parse_chord(chord.Chord([1, 3, 5], duration=duration.Duration(0.0))))\n\ntest_eq((\"R\", \"quarter\", 0), _parse_rest(note.Rest(duration=quarter)))\ntest_eq(None, _parse_rest(note.Rest(duration=duration.Duration(0.0))))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a normalization step, we need to transpose all the music to the same key, so we'll choose C for convenience.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e2be0813-df5b-4dc6-84f7-a25b34517128"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e2be0813-df5b-4dc6-84f7-a25b34517128');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "# export\n\n\ndef _transpose_to_C(s: stream.Stream) -> (stream.Stream, str):\n    \"Normalizes a stream to the C key, and returns the mode\"\n    k = s.analyze(\"key\")\n    i = interval.Interval(k.tonic, pitch.Pitch(\"C\"))\n    return s.transpose(i), k.mode";
                var nbb_formatted_code = "# export\n\n\ndef _transpose_to_C(s: stream.Stream) -> (stream.Stream, str):\n    \"Normalizes a stream to the C key, and returns the mode\"\n    k = s.analyze(\"key\")\n    i = interval.Interval(k.tonic, pitch.Pitch(\"C\"))\n    return s.transpose(i), k.mode";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test</span>
<span class="kn">from</span> <span class="nn">testing</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;data/ff4-main.mid&quot;</span><span class="p">)</span>
<span class="n">originalKey</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

<span class="n">transposed</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">_transpose_to_C</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">transposedKey</span> <span class="o">=</span> <span class="n">transposed</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="s2">&quot;CM&quot;</span><span class="p">),</span> <span class="n">transposedKey</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">originalKey</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="c16af572-b233-4917-b32e-dfc0e92f9939"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c16af572-b233-4917-b32e-dfc0e92f9939');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "# test\nfrom testing import test_eq\n\ns = converter.parse(\"data/ff4-main.mid\")\noriginalKey = s.analyze(\"key\")\n\ntransposed, mode = _transpose_to_C(s)\ntransposedKey = transposed.analyze(\"key\")\n\ntest_eq(key.Key(\"CM\"), transposedKey)\ntest_eq(originalKey.mode, mode)";
                var nbb_formatted_code = "# test\nfrom testing import test_eq\n\ns = converter.parse(\"data/ff4-main.mid\")\noriginalKey = s.analyze(\"key\")\n\ntransposed, mode = _transpose_to_C(s)\ntransposedKey = transposed.analyze(\"key\")\n\ntest_eq(key.Key(\"CM\"), transposedKey)\ntest_eq(originalKey.mode, mode)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="5dd12846-3080-4acb-ac65-86d3c50e6f71"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#5dd12846-3080-4acb-ac65-86d3c50e6f71');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "# export\n\n\ndef _parse_part(elements, mode) -> Optional[dict]:\n    d = {\n        \"notes\": [],\n        \"instrument\": \"unknown\",\n        \"bpm\": 120,\n        \"time_signature\": \"4/4\",\n        \"mode\": mode,\n    }\n\n    for element in elements:\n        if element.__class__ == note.Note:\n            x = _parse_single_note(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif element.__class__ == chord.Chord:\n            x = _parse_chord(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif element.__class__ == note.Rest:\n            x = _parse_rest(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif isinstance(element, instrument.Instrument):\n            if str(element) != \"\":\n                d[\"instrument\"] = str(element).lower()\n        elif element.__class__ == tempo.MetronomeMark:\n            d[\"bpm\"] = element.number\n        elif element.__class__ == meter.TimeSignature:\n            d[\"time_signature\"] = element.ratioString\n\n    if len(d[\"notes\"]) != 0:\n        return d\n    else:\n        return None";
                var nbb_formatted_code = "# export\n\n\ndef _parse_part(elements, mode) -> Optional[dict]:\n    d = {\n        \"notes\": [],\n        \"instrument\": \"unknown\",\n        \"bpm\": 120,\n        \"time_signature\": \"4/4\",\n        \"mode\": mode,\n    }\n\n    for element in elements:\n        if element.__class__ == note.Note:\n            x = _parse_single_note(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif element.__class__ == chord.Chord:\n            x = _parse_chord(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif element.__class__ == note.Rest:\n            x = _parse_rest(element)\n            if x is not None:\n                d[\"notes\"].append(x)\n        elif isinstance(element, instrument.Instrument):\n            if str(element) != \"\":\n                d[\"instrument\"] = str(element).lower()\n        elif element.__class__ == tempo.MetronomeMark:\n            d[\"bpm\"] = element.number\n        elif element.__class__ == meter.TimeSignature:\n            d[\"time_signature\"] = element.ratioString\n\n    if len(d[\"notes\"]) != 0:\n        return d\n    else:\n        return None";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test</span>
<span class="kn">from</span> <span class="nn">testing</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;data/rugrats.mid&quot;</span><span class="p">)</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">_parse_part</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">recurse</span><span class="p">(),</span> <span class="s2">&quot;major&quot;</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="s2">&quot;piano&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="mf">102.0</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;bpm&quot;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s2">&quot;4/4&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;time_signature&quot;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span>
    <span class="p">[(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;eighth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;breve&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;eighth&quot;</span><span class="p">,</span> <span class="mi">103</span><span class="p">)],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="9740ec28-764b-494a-bc9d-9af687bb86e4"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#9740ec28-764b-494a-bc9d-9af687bb86e4');

            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "# test\nfrom testing import test_eq\n\ns = converter.parse(\"data/rugrats.mid\")\nrow = _parse_part(s.parts[0].recurse(), \"major\")\n\ntest_eq(\"piano\", row[\"instrument\"])\ntest_eq(102.0, row[\"bpm\"])\ntest_eq(\"major\", row[\"mode\"])\ntest_eq(\"4/4\", row[\"time_signature\"])\ntest_eq(\n    [('R', 'eighth', 0), ('R', 'breve', 0), ('C3', 'eighth', 103)],\n    row[\"notes\"][0:3],\n)";
                var nbb_formatted_code = "# test\nfrom testing import test_eq\n\ns = converter.parse(\"data/rugrats.mid\")\nrow = _parse_part(s.parts[0].recurse(), \"major\")\n\ntest_eq(\"piano\", row[\"instrument\"])\ntest_eq(102.0, row[\"bpm\"])\ntest_eq(\"major\", row[\"mode\"])\ntest_eq(\"4/4\", row[\"time_signature\"])\ntest_eq(\n    [(\"R\", \"eighth\", 0), (\"R\", \"breve\", 0), (\"C3\", \"eighth\", 103)], row[\"notes\"][0:3]\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="c412e819-0af8-4a59-b617-cc50fc5a1b2b"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c412e819-0af8-4a59-b617-cc50fc5a1b2b');

            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "# export\n\n\ndef parse_midi_file(file: str) -> Optional[pd.DataFrame]:\n    \"\"\"\n    Attempts to parse a midi file into a Dataframe. Returns a Dataframe or None, together with the number of notes processed.\n    \"\"\"\n    try:\n        midi, mode = _transpose_to_C(converter.parse(file))\n        parts = instrument.partitionByInstrument(midi)\n        rows = []\n        if parts:\n            for part in parts:\n                parsed = _parse_part(part.recurse(), mode)\n                if parsed is not None:\n                    rows.append(parsed)\n        else:\n            parsed = _parse_part(midi.flat.notes, mode)\n            if parsed is not None:\n                rows.append(parsed)\n\n        for row in rows:\n            row[\"pitches\"] = [pitch for (pitch, dur, velocity) in row[\"notes\"]]\n            row[\"durations\"] = [dur for (pitch, dur, velocity) in row[\"notes\"]]\n            row[\"velocities\"] = [velocity for (pitch, dur, velocity) in row[\"notes\"]]\n            del row[\"notes\"]\n\n        return pd.DataFrame(rows)\n    except MidiException:\n        return None\n    except IndexError:\n        return None\n\n\ndef row_to_triplets(df: pd.DataFrame, row_index: int) -> Collection[Triplet]:\n    \"\"\"\n    Takes a DataFrame at a specific row and turns that into a triplet.\n    \"\"\"\n    pitches = df.get(\"pitches\")[row_index]\n    durations = df.get(\"durations\")[row_index]\n    velocities = df.get(\"velocities\")[row_index]\n    return list(zip(pitches, durations, velocities))";
                var nbb_formatted_code = "# export\n\n\ndef parse_midi_file(file: str) -> Optional[pd.DataFrame]:\n    \"\"\"\n    Attempts to parse a midi file into a Dataframe. Returns a Dataframe or None, together with the number of notes processed.\n    \"\"\"\n    try:\n        midi, mode = _transpose_to_C(converter.parse(file))\n        parts = instrument.partitionByInstrument(midi)\n        rows = []\n        if parts:\n            for part in parts:\n                parsed = _parse_part(part.recurse(), mode)\n                if parsed is not None:\n                    rows.append(parsed)\n        else:\n            parsed = _parse_part(midi.flat.notes, mode)\n            if parsed is not None:\n                rows.append(parsed)\n\n        for row in rows:\n            row[\"pitches\"] = [pitch for (pitch, dur, velocity) in row[\"notes\"]]\n            row[\"durations\"] = [dur for (pitch, dur, velocity) in row[\"notes\"]]\n            row[\"velocities\"] = [velocity for (pitch, dur, velocity) in row[\"notes\"]]\n            del row[\"notes\"]\n\n        return pd.DataFrame(rows)\n    except MidiException:\n        return None\n    except IndexError:\n        return None\n\n\ndef row_to_triplets(df: pd.DataFrame, row_index: int) -> Collection[Triplet]:\n    \"\"\"\n    Takes a DataFrame at a specific row and turns that into a triplet.\n    \"\"\"\n    pitches = df.get(\"pitches\")[row_index]\n    durations = df.get(\"durations\")[row_index]\n    velocities = df.get(\"velocities\")[row_index]\n    return list(zip(pitches, durations, velocities))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_midi_file" class="doc_header"><code>parse_midi_file</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/midi.py#L120" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_midi_file</code>(<strong><code>file</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Attempts to parse a midi file into a Dataframe. Returns a Dataframe or None, together with the number of notes processed.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="row_to_triplets" class="doc_header"><code>row_to_triplets</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/midi.py#L151" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>row_to_triplets</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>row_index</code></strong>:<code>int</code>)</p>
</blockquote>
<p>Takes a DataFrame at a specific row and turns that into a triplet.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls data
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ff4-airship.mid ff4-main.mid    ff4-town.mid    midi.tar.gz     rugrats.mid
</pre>
</div>
</div>

<div class="output_area">




<div id="0d0b762a-3884-4a55-83fa-cb9b38bf0f10"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#0d0b762a-3884-4a55-83fa-cb9b38bf0f10');

            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "!ls data";
                var nbb_formatted_code = "!ls data";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test</span>
<span class="kn">from</span> <span class="nn">testing</span> <span class="kn">import</span> <span class="n">test_eq</span><span class="p">,</span> <span class="n">path</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">parse_midi_file</span><span class="p">(</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;data/ff4-main.mid&quot;</span><span class="p">))</span>

<span class="n">test_eq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="s2">&quot;piano&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instrument&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">triplets</span> <span class="o">=</span> <span class="n">row_to_triplets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span>
    <span class="p">[(</span><span class="s2">&quot;E5&quot;</span><span class="p">,</span> <span class="s2">&quot;eighth&quot;</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;eighth&quot;</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;G4&quot;</span><span class="p">,</span> <span class="s2">&quot;eighth&quot;</span><span class="p">,</span> <span class="mi">110</span><span class="p">)],</span> <span class="n">triplets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">parse_midi_file</span><span class="p">(</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;data/rugrats.mid&quot;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="346faf63-4eb1-47fa-be2a-f90a6b118b4d"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#346faf63-4eb1-47fa-be2a-f90a6b118b4d');

            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "# test\nfrom testing import test_eq, path\n\ndf = parse_midi_file(path(\"data/ff4-main.mid\"))\n\ntest_eq(1, len(df))\ntest_eq(\"piano\", df.get(\"instrument\")[0])\n\ntriplets = row_to_triplets(df, 0)\n\ntest_eq(\n    [('E5', 'eighth', 110), ('B4', 'eighth', 110), ('G4', 'eighth', 110)], triplets[0:3]\n)\ntest_eq(1, len(df))\n\ndf = parse_midi_file(path(\"data/rugrats.mid\"))\ntest_eq(1, len(df))";
                var nbb_formatted_code = "# test\nfrom testing import test_eq, path\n\ndf = parse_midi_file(path(\"data/ff4-main.mid\"))\n\ntest_eq(1, len(df))\ntest_eq(\"piano\", df.get(\"instrument\")[0])\n\ntriplets = row_to_triplets(df, 0)\n\ntest_eq(\n    [(\"E5\", \"eighth\", 110), (\"B4\", \"eighth\", 110), (\"G4\", \"eighth\", 110)], triplets[0:3]\n)\ntest_eq(1, len(df))\n\ndf = parse_midi_file(path(\"data/rugrats.mid\"))\ntest_eq(1, len(df))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Turning-triplets-back-into-MIDI-streams">Turning triplets back into MIDI streams<a class="anchor-link" href="#Turning-triplets-back-into-MIDI-streams">&#182;</a></h2><p>Another interesting thing is to be able to go from triplets to MIDI streams, display their scores and even an audible IPython widget to play the audio.</p>
<p>But first of all, some utilities to turn these triplets into <code>music21</code> elements:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="31a90a4d-24e0-444f-94d9-174d1930a3bd"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#31a90a4d-24e0-444f-94d9-174d1930a3bd');

            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "# export\n\n\ndef triplet_to_note(triplet: Triplet):\n    pitch, dur, vel = triplet\n    dur = duration.Duration(dur)\n    vol = volume.Volume(velocity=vel)\n    if re.match(r\"^[0-9]\", pitch):\n        c = chord.Chord([int(x) for x in pitch.split(\".\")], duration=dur)\n        c.volume = vol\n        return c\n    elif pitch == \"R\":\n        return note.Rest(duration=dur)\n    else:\n        n = note.Note(pitch, duration=dur)\n        n.volume = vol\n        return n\n\n\ndef triplets_to_stream(triplets: Collection[Triplet]) -> stream.Stream:\n    s = stream.Stream()\n    _ = [s.append(triplet_to_note(triplet)) for triplet in triplets]\n    return s\n\n\ndef write_midi(stream, name):\n    mf = midi.translate.streamToMidiFile(stream)\n    mf.open(f\"{name}.mid\", \"wb\")\n    mf.write()\n    mf.close()";
                var nbb_formatted_code = "# export\n\n\ndef triplet_to_note(triplet: Triplet):\n    pitch, dur, vel = triplet\n    dur = duration.Duration(dur)\n    vol = volume.Volume(velocity=vel)\n    if re.match(r\"^[0-9]\", pitch):\n        c = chord.Chord([int(x) for x in pitch.split(\".\")], duration=dur)\n        c.volume = vol\n        return c\n    elif pitch == \"R\":\n        return note.Rest(duration=dur)\n    else:\n        n = note.Note(pitch, duration=dur)\n        n.volume = vol\n        return n\n\n\ndef triplets_to_stream(triplets: Collection[Triplet]) -> stream.Stream:\n    s = stream.Stream()\n    _ = [s.append(triplet_to_note(triplet)) for triplet in triplets]\n    return s\n\n\ndef write_midi(stream, name):\n    mf = midi.translate.streamToMidiFile(stream)\n    mf.open(f\"{name}.mid\", \"wb\")\n    mf.write()\n    mf.close()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="triplet_to_note" class="doc_header"><code>triplet_to_note</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/midi.py#L163" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>triplet_to_note</code>(<strong><code>triplet</code></strong>:<code>Tuple</code>[<code>str</code>, <code>float</code>, <code>int</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="triplets_to_stream" class="doc_header"><code>triplets_to_stream</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/midi.py#L179" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>triplets_to_stream</code>(<strong><code>triplets</code></strong>:<code>Collection</code>[<code>Tuple</code>[<code>str</code>, <code>float</code>, <code>int</code>]])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_midi" class="doc_header"><code>write_midi</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/midi.py#L185" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_midi</code>(<strong><code>stream</code></strong>, <strong><code>name</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's try to visualize and listen to these streams.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're running Mac or Linux, uncomment the right <code>brew</code> or <code>apt</code> call:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># skip</span>
<span class="c1"># hide</span>

<span class="c1">#!brew install fluidsynth</span>
<span class="c1">#!apt install fluidsynth</span>
<span class="c1">#!wget ftp://ftp.osuosl.org/pub/musescore/soundfont/MuseScore_General/MuseScore_General.sf3</span>
<span class="c1">#!pip install midi2audio</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--2019-12-08 01:55:32--  ftp://ftp.osuosl.org/pub/musescore/soundfont/MuseScore_General/MuseScore_General.sf3
           =&gt; ‘MuseScore_General.sf3’
Resolving ftp.osuosl.org (ftp.osuosl.org)... 140.211.166.134, 64.50.236.52, 64.50.233.100
Connecting to ftp.osuosl.org (ftp.osuosl.org)|140.211.166.134|:21... connected.
Logging in as anonymous ... Logged in!
==&gt; SYST ... done.    ==&gt; PWD ... done.
==&gt; TYPE I ... done.  ==&gt; CWD (1) /pub/musescore/soundfont/MuseScore_General ... done.
==&gt; SIZE MuseScore_General.sf3 ... 39893918
==&gt; PASV ... done.    ==&gt; RETR MuseScore_General.sf3 ... done.
Length: 39893918 (38M) (unauthoritative)

MuseScore_General.s 100%[===================&gt;]  38.04M  4.47MB/s    in 12s     

2019-12-08 01:55:48 (3.23 MB/s) - ‘MuseScore_General.sf3’ saved [39893918]

Requirement already satisfied: midi2audio in /Users/txus/Code/codegram/neuralmusic/env/lib/python3.7/site-packages (0.1.1)
</pre>
</div>
</div>

<div class="output_area">




<div id="9a825efe-edee-4033-a0a8-1654abc9cbae"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#9a825efe-edee-4033-a0a8-1654abc9cbae');

            setTimeout(function() {
                var nbb_cell_id = 70;
                var nbb_unformatted_code = "#!brew install fluidsynth\n#!apt install fluidsynth\n!wget ftp://ftp.osuosl.org/pub/musescore/soundfont/MuseScore_General/MuseScore_General.sf3\n!pip install midi2audio";
                var nbb_formatted_code = "#!brew install fluidsynth\n#!apt install fluidsynth\n!wget ftp://ftp.osuosl.org/pub/musescore/soundfont/MuseScore_General/MuseScore_General.sf3\n!pip install midi2audio";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># skip</span>
<span class="c1"># hide</span>

<span class="o">%</span><span class="k">load_ext</span> music21.ipython21.ipExtension

<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">Javascript</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Audio</span>

<span class="kn">from</span> <span class="nn">midi2audio</span> <span class="kn">import</span> <span class="n">FluidSynth</span>


<span class="k">def</span> <span class="nf">show_score</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;musicxml&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">show_xml</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_xml</span><span class="p">(</span><span class="n">xml</span><span class="p">):</span>
    <span class="n">DIV_ID</span> <span class="o">=</span> <span class="s2">&quot;OSMD-div-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span>
    <span class="c1"># print(&quot;DIV_ID&quot;, DIV_ID)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;loading OpenSheetMusicDisplay&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">display</span><span class="p">(</span>
        <span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&lt;div style=&quot;background: white&quot; id=&quot;&#39;</span> <span class="o">+</span> <span class="n">DIV_ID</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/div&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># print(&#39;xml length:&#39;, len(xml))</span>

    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    console.log(&quot;loadOSMD()&quot;);</span>
<span class="s2">    function loadOSMD() { </span>
<span class="s2">        return new Promise(function(resolve, reject){</span>

<span class="s2">            if (window.opensheetmusicdisplay) {</span>
<span class="s2">                console.log(&quot;already loaded&quot;)</span>
<span class="s2">                return resolve(window.opensheetmusicdisplay)</span>
<span class="s2">            }</span>
<span class="s2">            console.log(&quot;loading osmd for the first time&quot;)</span>
<span class="s2">            // OSMD script has a &#39;define&#39; call which conflicts with requirejs</span>
<span class="s2">            var _define = window.define // save the define object </span>
<span class="s2">            window.define = undefined // now the loaded script will ignore requirejs</span>
<span class="s2">            var s = document.createElement( &#39;script&#39; );</span>
<span class="s2">            s.setAttribute( &#39;src&#39;, &quot;https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@0.3.1/build/opensheetmusicdisplay.min.js&quot; );</span>
<span class="s2">            //s.setAttribute( &#39;src&#39;, &quot;/custom/opensheetmusicdisplay.js&quot; );</span>
<span class="s2">            s.onload=function(){</span>
<span class="s2">                window.define = _define</span>
<span class="s2">                console.log(&quot;loaded OSMD for the first time&quot;,opensheetmusicdisplay)</span>
<span class="s2">                resolve(opensheetmusicdisplay);</span>
<span class="s2">            };</span>
<span class="s2">            document.body.appendChild( s ); // browser will try to load the new script tag</span>
<span class="s2">        }) </span>
<span class="s2">    }</span>
<span class="s2">    loadOSMD().then((OSMD)=&gt;{</span>
<span class="s2">        console.log(&quot;loaded OSMD&quot;,OSMD)</span>
<span class="s2">        var div_id = &quot;{{DIV_ID}}&quot;;</span>
<span class="s2">            console.log(div_id)</span>
<span class="s2">        window.openSheetMusicDisplay = new OSMD.OpenSheetMusicDisplay(div_id);</span>
<span class="s2">        openSheetMusicDisplay</span>
<span class="s2">            .load({{data}})</span>
<span class="s2">            .then(</span>
<span class="s2">              function() {</span>
<span class="s2">                console.log(&quot;rendering data&quot;)</span>
<span class="s2">                openSheetMusicDisplay.render();</span>
<span class="s2">              }</span>
<span class="s2">            );</span>
<span class="s2">    })</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s2">&quot;{{DIV_ID}}&quot;</span><span class="p">,</span> <span class="n">DIV_ID</span>
    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s2">&quot;{{data}}&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Javascript</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">DIV_ID</span>


<span class="k">def</span> <span class="nf">view_song</span><span class="p">(</span><span class="n">triplets</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;song&quot;</span><span class="p">):</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">triplets_to_stream</span><span class="p">(</span><span class="n">triplets</span><span class="p">)</span>
    <span class="n">write_midi</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">FluidSynth</span><span class="p">(</span><span class="s2">&quot;MuseScore_General.sf3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">midi_to_audio</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">.mid&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">.wav&quot;</span><span class="p">)</span>
    <span class="n">show_score</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Audio</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">.wav&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="c2954128-ce06-4f06-9528-60ea67851e1d"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c2954128-ce06-4f06-9528-60ea67851e1d');

            setTimeout(function() {
                var nbb_cell_id = 71;
                var nbb_unformatted_code = "import json, random, re\n\nfrom IPython.core.display import display, HTML, Javascript\nfrom IPython.display import Audio\n\nfrom midi2audio import FluidSynth\n\n\ndef show_score(score):\n    xml = open(score.write(\"musicxml\")).read()\n    show_xml(xml)\n\n\ndef show_xml(xml):\n    DIV_ID = \"OSMD-div-\" + str(random.randint(0, 1000000))\n    # print(\"DIV_ID\", DIV_ID)\n    msg = \"loading OpenSheetMusicDisplay\"\n    msg = \"\"\n    display(\n        HTML('<div style=\"background: white\" id=\"' + DIV_ID + '\">{}</div>'.format(msg))\n    )\n\n    # print('xml length:', len(xml))\n\n    script = \"\"\"\n    console.log(\"loadOSMD()\");\n    function loadOSMD() { \n        return new Promise(function(resolve, reject){\n\n            if (window.opensheetmusicdisplay) {\n                console.log(\"already loaded\")\n                return resolve(window.opensheetmusicdisplay)\n            }\n            console.log(\"loading osmd for the first time\")\n            // OSMD script has a 'define' call which conflicts with requirejs\n            var _define = window.define // save the define object \n            window.define = undefined // now the loaded script will ignore requirejs\n            var s = document.createElement( 'script' );\n            s.setAttribute( 'src', \"https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@0.3.1/build/opensheetmusicdisplay.min.js\" );\n            //s.setAttribute( 'src', \"/custom/opensheetmusicdisplay.js\" );\n            s.onload=function(){\n                window.define = _define\n                console.log(\"loaded OSMD for the first time\",opensheetmusicdisplay)\n                resolve(opensheetmusicdisplay);\n            };\n            document.body.appendChild( s ); // browser will try to load the new script tag\n        }) \n    }\n    loadOSMD().then((OSMD)=>{\n        console.log(\"loaded OSMD\",OSMD)\n        var div_id = \"{{DIV_ID}}\";\n            console.log(div_id)\n        window.openSheetMusicDisplay = new OSMD.OpenSheetMusicDisplay(div_id);\n        openSheetMusicDisplay\n            .load({{data}})\n            .then(\n              function() {\n                console.log(\"rendering data\")\n                openSheetMusicDisplay.render();\n              }\n            );\n    })\n    \"\"\".replace(\n        \"{{DIV_ID}}\", DIV_ID\n    ).replace(\n        \"{{data}}\", json.dumps(xml)\n    )\n    display(Javascript(script))\n    return DIV_ID\n\n\ndef view_song(triplets, name=\"song\"):\n    stream = triplets_to_stream(triplets)\n    write_midi(stream, f\"{name}\")\n\n    FluidSynth('MuseScore_General.sf3').midi_to_audio(f\"{name}.mid\", f\"{name}.wav\")\n    show_score(stream)\n    return Audio(f\"{name}.wav\")";
                var nbb_formatted_code = "import json, random, re\n\nfrom IPython.core.display import display, HTML, Javascript\nfrom IPython.display import Audio\n\nfrom midi2audio import FluidSynth\n\n\ndef show_score(score):\n    xml = open(score.write(\"musicxml\")).read()\n    show_xml(xml)\n\n\ndef show_xml(xml):\n    DIV_ID = \"OSMD-div-\" + str(random.randint(0, 1000000))\n    # print(\"DIV_ID\", DIV_ID)\n    msg = \"loading OpenSheetMusicDisplay\"\n    msg = \"\"\n    display(\n        HTML('<div style=\"background: white\" id=\"' + DIV_ID + '\">{}</div>'.format(msg))\n    )\n\n    # print('xml length:', len(xml))\n\n    script = \"\"\"\n    console.log(\"loadOSMD()\");\n    function loadOSMD() { \n        return new Promise(function(resolve, reject){\n\n            if (window.opensheetmusicdisplay) {\n                console.log(\"already loaded\")\n                return resolve(window.opensheetmusicdisplay)\n            }\n            console.log(\"loading osmd for the first time\")\n            // OSMD script has a 'define' call which conflicts with requirejs\n            var _define = window.define // save the define object \n            window.define = undefined // now the loaded script will ignore requirejs\n            var s = document.createElement( 'script' );\n            s.setAttribute( 'src', \"https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@0.3.1/build/opensheetmusicdisplay.min.js\" );\n            //s.setAttribute( 'src', \"/custom/opensheetmusicdisplay.js\" );\n            s.onload=function(){\n                window.define = _define\n                console.log(\"loaded OSMD for the first time\",opensheetmusicdisplay)\n                resolve(opensheetmusicdisplay);\n            };\n            document.body.appendChild( s ); // browser will try to load the new script tag\n        }) \n    }\n    loadOSMD().then((OSMD)=>{\n        console.log(\"loaded OSMD\",OSMD)\n        var div_id = \"{{DIV_ID}}\";\n            console.log(div_id)\n        window.openSheetMusicDisplay = new OSMD.OpenSheetMusicDisplay(div_id);\n        openSheetMusicDisplay\n            .load({{data}})\n            .then(\n              function() {\n                console.log(\"rendering data\")\n                openSheetMusicDisplay.render();\n              }\n            );\n    })\n    \"\"\".replace(\n        \"{{DIV_ID}}\", DIV_ID\n    ).replace(\n        \"{{data}}\", json.dumps(xml)\n    )\n    display(Javascript(script))\n    return DIV_ID\n\n\ndef view_song(triplets, name=\"song\"):\n    stream = triplets_to_stream(triplets)\n    write_midi(stream, f\"{name}\")\n\n    FluidSynth(\"MuseScore_General.sf3\").midi_to_audio(f\"{name}.mid\", f\"{name}.wav\")\n    show_score(stream)\n    return Audio(f\"{name}.wav\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># skip</span>
<span class="n">triplets</span> <span class="o">=</span> <span class="n">row_to_triplets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">view_song</span><span class="p">(</span><span class="n">triplets</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

