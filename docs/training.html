---

title: Training
keywords: fastai
sidebar: home_sidebar

summary: "Training the model"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_training.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="381c6490-455d-486f-a326-d521c715a33f"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#381c6490-455d-486f-a326-d521c715a33f');

            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "# export\nfrom torch import nn\nfrom fastai2.basics import (\n    Recorder,\n    CrossEntropyLossFlat,\n    flatten_check,\n    accuracy,\n    Callback,\n    DataBunch,\n    Learner,\n)\nfrom fastai2.callback.schedule import *\nfrom fastai2.callback.progress import *\nfrom fastai2.callback.fp16 import *";
                var nbb_formatted_code = "# export\nfrom torch import nn\nfrom fastai2.basics import (\n    Recorder,\n    CrossEntropyLossFlat,\n    flatten_check,\n    accuracy,\n    Callback,\n    DataBunch,\n    Learner,\n)\nfrom fastai2.callback.schedule import *\nfrom fastai2.callback.progress import *\nfrom fastai2.callback.fp16 import *";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="9f42481e-c797-4b72-a0c6-4d4400969e4c"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#9f42481e-c797-4b72-a0c6-4d4400969e4c');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "# export\nclass DualCrossEntropyLossFlat(CrossEntropyLossFlat):\n    def __call__(self, inp, targ, **kwargs):\n        pitches_targ, durations_targ = targ.transpose(0, 1)\n        pitches_targ = pitches_targ.transpose(0,1)[-1]\n        durations_targ = durations_targ.transpose(0,1)[-1]\n        pitches_input = inp[0].transpose(0,1)[-1]\n        durations_input = inp[1].transpose(0,1)[-1]\n        pitches_loss = super().__call__(pitches_input, pitches_targ, **kwargs)\n        durations_loss = super().__call__(durations_input, durations_targ, **kwargs)\n        return (pitches_loss + durations_loss) / 2\n    \ndef pitch_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0,1)\n    return accuracy(inp[0], targ_pitches)\n\ndef rhythm_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0,1)\n    return accuracy(inp[1], targ_durations)\n\ndef avg_accuracy(inp, targ):\n    return (pitch_accuracy(inp, targ) + rhythm_accuracy(inp, targ)) / 2\n\nclass ResetTrainer(Callback):\n    def begin_train(self):    self.model.reset()\n    def begin_validate(self): self.model.reset()";
                var nbb_formatted_code = "# export\nclass DualCrossEntropyLossFlat(CrossEntropyLossFlat):\n    def __call__(self, inp, targ, **kwargs):\n        pitches_targ, durations_targ = targ.transpose(0, 1)\n        pitches_targ = pitches_targ.transpose(0, 1)[-1]\n        durations_targ = durations_targ.transpose(0, 1)[-1]\n        pitches_input = inp[0].transpose(0, 1)[-1]\n        durations_input = inp[1].transpose(0, 1)[-1]\n        pitches_loss = super().__call__(pitches_input, pitches_targ, **kwargs)\n        durations_loss = super().__call__(durations_input, durations_targ, **kwargs)\n        return (pitches_loss + durations_loss) / 2\n\n\ndef pitch_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[0], targ_pitches)\n\n\ndef rhythm_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[1], targ_durations)\n\n\ndef avg_accuracy(inp, targ):\n    return (pitch_accuracy(inp, targ) + rhythm_accuracy(inp, targ)) / 2\n\n\nclass ResetTrainer(Callback):\n    def begin_train(self):\n        self.model.reset()\n\n    def begin_validate(self):\n        self.model.reset()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DualCrossEntropyLossFlat" class="doc_header"><code>class</code> <code>DualCrossEntropyLossFlat</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DualCrossEntropyLossFlat</code>(<strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>flatten</code></strong>=<em><code>True</code></em>, <strong><code>floatify</code></strong>=<em><code>False</code></em>, <strong><code>is_2d</code></strong>=<em><code>True</code></em>, <strong><code>activation</code></strong>=<em><code>None</code></em>, <strong><code>decodes</code></strong>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>CrossEntropyLossFlat</code></p>
</blockquote>
<p>Same as <code>nn.CrossEntropyLoss</code>, but flattens input and target.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pitch_accuracy" class="doc_header"><code>pitch_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pitch_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rhythm_accuracy" class="doc_header"><code>rhythm_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rhythm_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="avg_accuracy" class="doc_header"><code>avg_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L44" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>avg_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ResetTrainer" class="doc_header"><code>class</code> <code>ResetTrainer</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L48" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ResetTrainer</code>() :: <code>Callback</code></p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="a24865a2-2f75-4b7f-a5e6-3fff9f0431ee"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#a24865a2-2f75-4b7f-a5e6-3fff9f0431ee');

            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "# export\n\n\ndef get_learner(db: DataBunch, model: nn.Module) -> Learner:\n    \"\"\"\n    Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.\n    \"\"\"\n    return Learner(\n        db,\n        model,\n        loss_func=DualCrossEntropyLossFlat(),\n        cb_funcs=ResetTrainer,\n        metrics=[pitch_accuracy, rhythm_accuracy, avg_accuracy],\n    )";
                var nbb_formatted_code = "# export\n\n\ndef get_learner(db: DataBunch, model: nn.Module) -> Learner:\n    \"\"\"\n    Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.\n    \"\"\"\n    return Learner(\n        db,\n        model,\n        loss_func=DualCrossEntropyLossFlat(),\n        cb_funcs=ResetTrainer,\n        metrics=[pitch_accuracy, rhythm_accuracy, avg_accuracy],\n    )";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_learner" class="doc_header"><code>get_learner</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_learner</code>(<strong><code>db</code></strong>:<code>DataBunch</code>, <strong><code>model</code></strong>:<code>Module</code>)</p>
</blockquote>
<p>Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.</p>

</div>

</div>

</div>
</div>

</div>
</div>
 

