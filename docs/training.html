---

title: Training
keywords: fastai
sidebar: home_sidebar

summary: "Training the model"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_training.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e3d62b74-ef9d-4da5-969c-5f03594a95ae"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e3d62b74-ef9d-4da5-969c-5f03594a95ae');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "# export\nfrom torch import nn\nfrom fastai2.basics import (\n    CrossEntropyLossFlat,\n    accuracy,\n    Callback,\n    DataBunch,\n    Learner,\n)\nfrom fastai2.callback.schedule import *\nfrom fastai2.callback.progress import *\nfrom fastai2.callback.fp16 import *";
                var nbb_formatted_code = "# export\nfrom torch import nn\nfrom fastai2.basics import CrossEntropyLossFlat, accuracy, Callback, DataBunch, Learner\nfrom fastai2.callback.schedule import *\nfrom fastai2.callback.progress import *\nfrom fastai2.callback.fp16 import *";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="03ca73e0-9982-4a44-8082-0e910814f1cc"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#03ca73e0-9982-4a44-8082-0e910814f1cc');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "# export\n\n\nclass DualCrossEntropyLossFlat(CrossEntropyLossFlat):\n    \"\"\"\n    Average of a tuple of cross-entropy losses. Not sure it's a good idea.\n    \"\"\"\n\n    def __call__(self, inp, targ, **kwargs):\n        pitches_targ, durations_targ = targ.transpose(0, 1)\n        pitches_targ = pitches_targ.transpose(0, 1)[-1]\n        durations_targ = durations_targ.transpose(0, 1)[-1]\n        pitches_input = inp[0].transpose(0, 1)[-1]\n        durations_input = inp[1].transpose(0, 1)[-1]\n        pitches_loss = super().__call__(pitches_input, pitches_targ, **kwargs)\n        durations_loss = super().__call__(durations_input, durations_targ, **kwargs)\n        return (pitches_loss + durations_loss) / 2\n\n\ndef pitch_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[0], targ_pitches)\n\n\ndef rhythm_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[1], targ_durations)\n\n\ndef avg_accuracy(inp, targ):\n    return (pitch_accuracy(inp, targ) + rhythm_accuracy(inp, targ)) / 2\n\n\nclass ResetTrainer(Callback):\n    \"Reset the model when switching between training and validation.\"\n\n    def begin_train(self):\n        self.model.reset()\n\n    def begin_validate(self):\n        self.model.reset()";
                var nbb_formatted_code = "# export\n\n\nclass DualCrossEntropyLossFlat(CrossEntropyLossFlat):\n    \"\"\"\n    Average of a tuple of cross-entropy losses. Not sure it's a good idea.\n    \"\"\"\n\n    def __call__(self, inp, targ, **kwargs):\n        pitches_targ, durations_targ = targ.transpose(0, 1)\n        pitches_targ = pitches_targ.transpose(0, 1)[-1]\n        durations_targ = durations_targ.transpose(0, 1)[-1]\n        pitches_input = inp[0].transpose(0, 1)[-1]\n        durations_input = inp[1].transpose(0, 1)[-1]\n        pitches_loss = super().__call__(pitches_input, pitches_targ, **kwargs)\n        durations_loss = super().__call__(durations_input, durations_targ, **kwargs)\n        return (pitches_loss + durations_loss) / 2\n\n\ndef pitch_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[0], targ_pitches)\n\n\ndef rhythm_accuracy(inp, targ):\n    targ_pitches, targ_durations = targ.transpose(0, 1)\n    return accuracy(inp[1], targ_durations)\n\n\ndef avg_accuracy(inp, targ):\n    return (pitch_accuracy(inp, targ) + rhythm_accuracy(inp, targ)) / 2\n\n\nclass ResetTrainer(Callback):\n    \"Reset the model when switching between training and validation.\"\n\n    def begin_train(self):\n        self.model.reset()\n\n    def begin_validate(self):\n        self.model.reset()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DualCrossEntropyLossFlat" class="doc_header"><code>class</code> <code>DualCrossEntropyLossFlat</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L16" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DualCrossEntropyLossFlat</code>(<strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>flatten</code></strong>=<em><code>True</code></em>, <strong><code>floatify</code></strong>=<em><code>False</code></em>, <strong><code>is_2d</code></strong>=<em><code>True</code></em>, <strong><code>activation</code></strong>=<em><code>None</code></em>, <strong><code>decodes</code></strong>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>CrossEntropyLossFlat</code></p>
</blockquote>
<p>Average of a tuple of cross-entropy losses. Not sure it's a good idea.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pitch_accuracy" class="doc_header"><code>pitch_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L32" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pitch_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rhythm_accuracy" class="doc_header"><code>rhythm_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rhythm_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="avg_accuracy" class="doc_header"><code>avg_accuracy</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>avg_accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ResetTrainer" class="doc_header"><code>class</code> <code>ResetTrainer</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L46" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ResetTrainer</code>() :: <code>Callback</code></p>
</blockquote>
<p>Reset the model when switching between training and validation.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="0959c823-e42b-47b1-a9f8-b43603be0790"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#0959c823-e42b-47b1-a9f8-b43603be0790');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "# export\n\n\ndef get_learner(db: DataBunch, model: nn.Module) -> Learner:\n    \"\"\"\n    Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.\n    \"\"\"\n    return Learner(\n        db,\n        model,\n        loss_func=DualCrossEntropyLossFlat(),\n        cb_funcs=ResetTrainer,\n        metrics=[pitch_accuracy, rhythm_accuracy, avg_accuracy],\n    )";
                var nbb_formatted_code = "# export\n\n\ndef get_learner(db: DataBunch, model: nn.Module) -> Learner:\n    \"\"\"\n    Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.\n    \"\"\"\n    return Learner(\n        db,\n        model,\n        loss_func=DualCrossEntropyLossFlat(),\n        cb_funcs=ResetTrainer,\n        metrics=[pitch_accuracy, rhythm_accuracy, avg_accuracy],\n    )";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_learner" class="doc_header"><code>get_learner</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_learner</code>(<strong><code>db</code></strong>:<code>DataBunch</code>, <strong><code>model</code></strong>:<code>Module</code>)</p>
</blockquote>
<p>Constructs a learner from a databunch, using DualCrossEntroyLossFlat as a loss function.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="b2051fc4-bb7c-4e39-8289-1ae91f5e564e"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#b2051fc4-bb7c-4e39-8289-1ae91f5e564e');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "# export\n\ndef train(learn: Learner, epochs=10, max_lr=1e-03):\n    \"Train the model for a number of `epochs`.\"\n    learn.fit(10, max_lr=max_lr)";
                var nbb_formatted_code = "# export\n\n\ndef train(learn: Learner, epochs=10, max_lr=1e-03):\n    \"Train the model for a number of `epochs`.\"\n    learn.fit(10, max_lr=max_lr)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train" class="doc_header"><code>train</code><a href="https://github.com/codegram/neuralmusic/tree/master/neuralmusic/training.py#L73" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train</code>(<strong><code>learn</code></strong>:<code>Learner</code>, <strong><code>epochs</code></strong>=<em><code>10</code></em>, <strong><code>max_lr</code></strong>=<em><code>0.001</code></em>)</p>
</blockquote>
<p>Train the model for a number of <code>epochs</code>.</p>

</div>

</div>

</div>
</div>

</div>
</div>
 

