project:
  name: ml-project
  syncFilters:
    - exclude:
        - .circleci/*
        - .pytest_cache/*
        - .git/*
        - .vscode/*
        - env/*
        - infra/*
        - mlruns/*
        - "*/__pycache__/*"

container:
  projectDir: /workspace/project
  file: docker/Dockerfile
  ports: [6006, 8888]
  volumeMounts:
    - name: workspace
      mountPath: /workspace

instances:
  - name: i1
    provider: gcp
    parameters:
      zone: asia-east1-a
      gpu:
        type: nvidia-tesla-k80
        count: 1
      machineType: n1-standard-1
      volumes:
        - name: workspace
          parameters:
            deletionPolicy: delete
            size: 20

scripts:
  deps: |
    source /miniconda/bin/activate
    conda env update --prefix ./env --file conda.yml
  train: |
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONPATH=/workspace/project
    source /miniconda/bin/activate
    conda activate ./env
    export $(cat .env | grep MLFLOW_TRACKING_URI)
    python train.py
  jupyter: |
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONPATH=/workspace/project
    source /miniconda/bin/activate
    conda activate ./env
    export CUDA_LAUNCH_BLOCKING=1
    jupyter notebook --allow-root --notebook-dir=notebooks --ip=0.0.0.0 --port=8888
  gpu-check: |
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    nvcc --version
  tensorboard: |
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONPATH=/workspace/project
    source /miniconda/bin/activate
    conda activate ./env
    tensorboard --logdir=logs
